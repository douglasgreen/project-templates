security:secrets:
  stage: security
  image: python:3.12-slim
  <<: *job-template
  script:
    - pip install detect-secrets
    - detect-secrets scan --all-files --force-use-all-plugins --baseline .secrets.baseline
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

security:dependencies:
  stage: security
  image: node:20
  <<: *job-template
  script:
    - npm audit --audit-level=moderate
    - npm ci
    - npx audit-ci --moderate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

sast:
  stage: security
  include:
    - template: Jobs/SAST.gitlab-ci.yml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

dependency-scanning:
  stage: security
  include:
    - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

container-scanning:
  stage: security
  include:
    - template: Jobs/Container-Scanning.gitlab-ci.yml
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
