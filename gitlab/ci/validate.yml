lint:commit:
  stage: validate
  image: node:20-alpine
  <<: *job-template
  script:
    - npm ci
    - npx commitlint --from=${CI_MERGE_REQUEST_DIFF_BASE_SHA:-HEAD~1} --to=${CI_COMMIT_SHA} --verbose
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

lint:yaml:
  stage: validate
  image: python:3.12-slim
  <<: *job-template
  script:
    - pip install yamllint==1.35.1
    - yamllint -c .yamllint.yml .
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

lint:json:
  stage: validate
  image: node:20-alpine
  <<: *job-template
  script:
    - find . -name "*.json" -not -path "./node_modules/*" -exec node -e "JSON.parse(require('fs').readFileSync(process.argv[1]))" {} \;
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

lint:sql:
  stage: validate
  image: python:3.12-slim
  <<: *job-template
  script:
    - pip install sqlfluff==3.0.0
    - sqlfluff lint --dialect ansi .
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

lint:php:
  stage: validate
  image: php:8.3-cli
  <<: *job-template
  script:
    - |
      apt-get update && apt-get install -y git unzip
      curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
      composer install --no-interaction --optimize-autoloader
      vendor/bin/phpcs --standard=PSR12 --report=junit --report-file=phpcs-report.xml src/ tests/
  artifacts:
    reports:
      junit: phpcs-report.xml
    when: always
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

analyze:php:
  stage: validate
  image: php:8.3-cli
  <<: *job-template
  script:
    - |
      apt-get update && apt-get install -y git unzip
      curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
      composer install --no-interaction
      vendor/bin/phpstan analyse --configuration=phpstan.neon --error-format=gitlab > phpstan-report.json
  artifacts:
    reports:
      codequality: phpstan-report.json
    when: always
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

lint:python:
  stage: validate
  image: python:3.12
  <<: *job-template
  script:
    - pip install ruff mypy
    - ruff check .
    - ruff format --check .
    - mypy --strict src/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

lint:js:
  stage: validate
  image: node:20
  <<: *job-template
  script:
    - npm ci
    - npm run lint
    - npm run typecheck
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

lint:go:
  stage: validate
  image: golang:1.22
  <<: *job-template
  script:
    - go fmt ./...
    - go vet ./...
    - test -z "$(gofmt -l .)"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
