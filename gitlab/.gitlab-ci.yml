workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'
    - when: never

stages:
  - validate
  - security
  - test
  - build
  - deploy

default:
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

variables:
  # Global settings
  GIT_DEPTH: 20
  GIT_STRATEGY: fetch
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"

# Cache templates
.global-cache: &global-cache
  key:
    files:
      - package-lock.json
      - composer.lock
      - poetry.lock
      - go.sum
  paths:
    - node_modules/
    - vendor/
    - .cache/
  policy: pull-push

# Job templates
.job-template: &job-template
  timeout: 30 minutes
  tags:
    - docker
  before_script:
    - set -euo pipefail

include:
  - local: .gitlab/ci/validate.yml
  - local: .gitlab/ci/security.yml
  - local: .gitlab/ci/test.yml
  - local: .gitlab/ci/build.yml
  - local: .gitlab/ci/deploy.yml
